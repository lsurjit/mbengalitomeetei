
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manipuri Script transliteration</title>
    <style>
        /* Modern Fluent/Glassmorphism Defaults */
        :root {
            --primary: #0078d4; 
            --bg: #f8fafc;
            --text: #1e293b;
            --border: #e2e8f0;
            --white: #ffffff;
            --success: #107c10;
            --error: #ef4444;
            --premium: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --a4-width: 816px;
            --a4-height: 1056px;
            --radius: 8px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        /* Header - Clean Style */
        header {
            background: var(--white);
            color: var(--text);
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            flex-shrink: 0;
            height: 60px;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .header-left-side, .header-right-side {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 10;
            flex: 1;
        }

        .header-right-side {
            justify-content: flex-end;
        }
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
        }

       .header-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--primary);
        }

        .header-subtitle {
            margin: 0;
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
        }

        .user-info-chip {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.2;
            margin-right: 12px;
            padding: 4px 12px;
            background: var(--bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .user-name-display {
            font-weight: 600;
            color: var(--text);
            font-size: 0.85rem;
        }

        .user-days-display {
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .auth-buttons, .tool-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-buttons {
            display: none; 
        }

        .auth-btn, .tool-btn {
            background: var(--white);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .auth-btn:hover, .tool-btn:hover {
            background: #f1f5f9;
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .auth-btn-premium {
            background: var(--primary);
            color: white !important;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        /* View Containers */
        .view-container {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            position: relative;
        }

        .view-container.active {
            display: flex;
        }

        /* Ribbon Styles */
        .office-ribbon {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
            overflow-x: auto;
        }

        .ribbon-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-right: 1px solid var(--border);
            padding-right: 1.25rem;
        }

        .ribbon-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .ribbon-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            color: #475569;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            font-size: 0.85rem;
        }

        .ribbon-btn:hover { 
            background: #f1f5f9; 
            color: var(--primary);
            border-color: var(--primary);
        }

        .ribbon-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .ribbon-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            background: var(--white);
        }

        /* Typing Workspace */
       .typing-workspace {
            flex: 1;
            background: #e2e8f0;               
            overflow-y: auto;                  
            display: flex;
            flex-direction: column;
            align-items: center;               
            padding: 40px 0;
            gap: 30px;                          
        }

        .word-page {
            background: white;
            width: 8.27in;                      
            min-height: 11.69in;                
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1),
                        0 8px 10px -6px rgba(0,0,0,0.1);
            position: relative;
            padding: 1in;                        
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            border-radius: 2px;
            flex-shrink: 0;
            overflow: hidden;                    
            font-family: 'Times New Roman', serif;
            line-height: 1.5;
            color: #000;
        }

        .page-content-area {
            flex: 1;
            outline: none;
            font-family: "Calibri", "Inter", sans-serif;
            font-size: 14px;
            line-height: 1.5;
            width: 100%;
            background: transparent;
            padding: 0;                          
            overflow: hidden;                     
            white-space: pre-wrap;
            overflow-wrap: break-word;
            box-sizing: border-box;
            caret-color: black;
        }

        .page-status-popup {
            position: absolute;
            bottom: 24px;
            left: 24px;
            background: var(--white);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow-md);
            z-index: 150;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            pointer-events: none; 
            transition: transform 0.3s ease;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 120, 212, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 120, 212, 0); }
        }

        .converter-content {
            flex: 1;
            display: flex;
            gap: 0; 
            padding: 0; 
            width: 100vw;
            height: calc(100vh - 60px);
            box-sizing: border-box;
            background: #f1f5f9;
            position: relative;
        }

        .card-container {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            box-sizing: border-box;
            height: 100%;
            border: none;
            border-radius: 0;
            position: relative;
        }

        .card-container:first-child {
            border-right: 1px solid var(--border);
        }

        .converter-textarea {
            flex: 1;
            border: 1px solid #f1f5f9;
            background: #fcfcfc;
            border-radius: 8px;
            padding: 2.5rem; 
            font-size: 1.6rem;
            resize: none;
            outline: none;
            margin-top: 0.75rem;
            font-family: inherit;
            color: var(--text);
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .converter-textarea:focus {
            background: var(--white);
            border-color: var(--primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.02), 0 0 0 4px rgba(0, 120, 212, 0.05);
        }

        .btn-swap-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }

        .btn-swap {
            background: var(--primary);
            border: 4px solid white;
            color: white;
            width: 52px; 
            height: 52px; 
            border-radius: 50%;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            font-size: 1.4rem;
        }

        .btn-swap:hover { 
            transform: scale(1.1) rotate(180deg); 
            background: #005a9e;
        }

        .keyboard-layout-container {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            border: 1px solid var(--border);
            z-index: 100;
            width: 90%;
            max-width: 800px;
        }

        .kb-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
        .kb-key {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 48px;
            height: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .kb-key span { font-size: 0.7rem; color: #94a3b8; }
        .kb-key .char { font-size: 1.1rem; color: var(--text); font-weight: 600; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #64748b; 
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: #f8fafc;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .login-submit { 
            width: 100%; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 0.8rem; 
            cursor: pointer; 
            border-radius: 8px; 
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.2s;
        }
        .login-submit:hover { opacity: 0.9; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 50px; 
            display: none; z-index: 2000; font-size: 0.9rem; font-weight: 500;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .app-lock-overlay {
            display: none;
            position: absolute;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100% - 60px);
            background: rgba(248, 250, 252, 0.95);
            z-index: 500;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .forgot-link {
            display: block;
            text-align: right;
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            margin-top: -10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .converter-content { flex-direction: column; }
            .card-container:first-child { border-right: none; border-bottom: 1px solid var(--border); }
            .btn-swap-wrapper { transform: translate(-50%, -50%) rotate(90deg); }
            .page-status-popup { left: 10px; bottom: 10px; }
        }

        @media print {
            body, .typing-workspace { background: white !important; overflow: visible !important; display: block !important; padding: 0 !important; }
            header, .office-ribbon, .keyboard-layout-container, #lockOverlay, #toast, .page-status-popup { display: none !important; }
            .word-page { box-shadow: none !important; margin: 0 !important; page-break-after: always !important; border: none !important; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left-side">
            <div class="auth-buttons" id="logged-out-auth">
                <button class="auth-btn" onclick="openModal('loginModal')">Login</button>
                <button id="header-reg-btn" class="auth-btn" onclick="openRegisterModal()">Registration</button>
            </div>
            
            <div id="logged-in-user-area" style="display:none; align-items:center;">
                <div class="user-info-chip">
                    <span id="display-user-name" class="user-name-display">User Name</span>
                    <span id="display-user-days" class="user-days-display">0 Days Left</span>
                </div>
                <button id="logout-btn" class="auth-btn" style="color:var(--error); border-color: #fee2e2;" onclick="location.reload()">Sign Out</button>
            </div>
        </div>
        <div class="header-center">
            <h1 class="header-title">Manipuri Script Utility</h1>
            <p class="header-subtitle" id="trans-label">Bengali to Meetei Mayek</p>
        </div>

        <div class="header-right-side">
            <div class="tool-buttons" id="tool-buttons">
                <button class="tool-btn" onclick="switchView('conversionView')">Converter</button>
                <button class="tool-btn" onclick="switchView('typingToolView')">Typing Tool</button>
                <button class="tool-btn" onclick="openModal('settingsModal')">Settings</button>
            </div>
            <button id="buy-plan-btn" class="auth-btn auth-btn-premium" onclick="showToast('Loading Plans...')">üëë Upgrade</button>
        </div>
    </header>

    <div id="lockOverlay" class="app-lock-overlay">
        <div style="background: white; padding: 3rem; border-radius: 24px; box-shadow: var(--shadow-md); max-width: 450px; width: 90%;">
            <div id="lock-emoji" style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
            <h2 id="lock-title" style="color: var(--text); margin-bottom: 1rem; font-weight: 800;">Get Full Access</h2>
            <p id="lock-message" style="color: #64748b; margin-bottom: 2rem; line-height: 1.6;">
                Your preview period has ended. Register for free to unlock the Typing Tool and custom dictionaries.
            </p>
            <div id="lock-actions">
                <button class="login-submit" onclick="openRegisterModal()">Create Free Account</button>
                <p style="margin-top: 20px; font-size: 0.9rem; color: #94a3b8;">
                    Already a member? <span style="color: var(--primary); cursor: pointer; font-weight: 600;" onclick="openModal('loginModal')">Login</span>
                </p>
            </div>
        </div>
    </div>

    <!-- CONVERTER -->
    <div id="conversionView" class="view-container active">
        <div class="converter-content">
            <div class="card-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="ribbon-label">Source</span>
                    <select id="in-lang" class="ribbon-select" onchange="handleConversion()">
                        <option value="bengali">Bengali (Manipuri)</option>
                        <option value="meetei">Meetei Mayek</option>
                    </select>
                </div>
                <textarea id="input-text" class="converter-textarea" placeholder="Paste or type text here..." oninput="handleConversion()"></textarea>
            </div>
            
            <div class="btn-swap-wrapper">
                <button class="btn-swap" onclick="swapLangs()" title="Swap Scripts">‚áÑ</button>
            </div>
            
            <div class="card-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="ribbon-label">Target</span>
                    <select id="out-lang" class="ribbon-select" onchange="handleConversion()">
                        <option value="bengali">Bengali (Manipuri)</option>
                        <option value="meetei" selected>Meetei Mayek</option>
                    </select>
                </div>
                <textarea id="output-text" class="converter-textarea" readonly placeholder="Converted text will appear here..."></textarea>
            </div>
        </div>
    </div>

    <!-- TYPING TOOL -->
    <div id="typingToolView" class="view-container">
        <div class="office-ribbon">
            <div class="ribbon-group">
                <span class="ribbon-label">File Management</span>
                <button class="ribbon-btn" onclick="openFile()" title="Open File (Ctrl+O)">üìÇ Open</button>
                <button class="ribbon-btn" onclick="saveFile()" title="Save File (Ctrl+S)">üíæ Save</button>
            </div>

            <div class="ribbon-group">
                <span class="ribbon-label">History</span>
                <button class="ribbon-btn" onclick="document.execCommand('undo')" title="Undo (Ctrl+Z)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                </button>
                <button class="ribbon-btn" onclick="document.execCommand('redo')" title="Redo (Ctrl+Y)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>
                </button>
            </div>

            <div class="ribbon-group">
                <span class="ribbon-label">Select </span>
                <select id="type-lang" class="ribbon-select" onchange="updateKeyboardOptions()">
                    <option value="english">English</option>
                    <option value="bengali">Bengali (Manipuri)</option>
                    <option value="meetei">Meetei Mayek</option>
                </select>
                <select id="kb-layout" class="ribbon-select" style="display:none" onchange="fetchKeymap(this.value)"></select>
                <button class="ribbon-btn" onclick="toggleKeyboardMap()" title="Toggle Visual Keyboard">‚å®Ô∏è Kb_Layout</button>
            </div>
            
            <div class="ribbon-group">
                <span class="ribbon-label">Style</span>
                <select id="f-size" class="ribbon-select" onchange="applyTypingStyle('fontSize', this.value)">
                    <option value="11pt">Size: 11</option>
                    <option value="12pt">Size: 12</option>
                    <option value="14pt" selected>Size: 14</option>
                    <option value="18pt">Size: 18</option>
                    <option value="24pt">Size: 24</option>
                </select>
                <select id="l-spacing" class="ribbon-select" onchange="applyTypingStyle('lineHeight', this.value)">
                    <option value="1.0">Line: 1.0</option>
                    <option value="1.15">Line: 1.15</option>
                    <option value="1.5">Line: 1.5</option>
                    <option value="1.6" selected>Line: 1.6</option>
                    <option value="2.0">Line: 2.0</option>
                    <option value="2.5">Line: 2.5</option>
                    <option value="3.0">Line: 3.0</option>
                </select>
            </div>

            <div class="ribbon-group">
                <span class="ribbon-label">Align</span>
                <button class="ribbon-btn align-btn active" id="align-left" onclick="setTextAlignment('left')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h10M3 18h18"/></svg>
                </button>
                <button class="ribbon-btn align-btn" id="align-center" onclick="setTextAlignment('center')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M7 12h10M3 18h18"/></svg>
                </button>
                <button class="ribbon-btn align-btn" id="align-right" onclick="setTextAlignment('right')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M11 12h10M3 18h18"/></svg>
                </button>
                <button class="ribbon-btn align-btn" id="align-justify" onclick="setTextAlignment('justify')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
                </button>
            </div>

            <div class="ribbon-group" style="border-right: none; margin-left: auto;">
                <button class="ribbon-btn" onclick="addNewTypingPage()" title="Add New Page">‚ûï Page</button>
                <button class="ribbon-btn" onclick="exportToDoc()" style="background: var(--primary); color: white; font-weight: 600; padding: 0.5rem 1.25rem; border:none;">
                    üìÑ Save .doc
                </button>
                <button class="ribbon-btn" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
        </div>

        <div class="typing-workspace" id="pages-container"></div>

        <div id="pageStatusPopup" class="page-status-popup">
            <div class="status-dot"></div>
            <span id="pageProgressText">Page 1 of 1</span>
        </div>

        <div id="kb-map" class="keyboard-layout-container">
            <div id="kb-grid"></div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="file-open-input" style="display:none" accept=".txt,.meetei" onchange="handleFileOpen(event)">

    <!-- MODALS -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="login-step-main">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin:0; font-weight: 800;">Welcome Back</h3>
                    <button onclick="closeModal('loginModal')" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#94a3b8;">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="user" class="form-input" placeholder="e.g. john_doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="pass" class="form-input" placeholder="********" onkeydown="if(event.key==='Enter') doLogin()">
                </div>
                <span class="forgot-link" onclick="switchLoginStep('reset-1')">Forgot Password?</span>
                <button class="login-submit" onclick="doLogin()">Sign In</button>
                <p id="login-to-reg-prompt" style="text-align: center; font-size: 0.85rem; color: #64748b; margin-top: 1rem;">
                    Don't have an account? <span style="color: var(--primary); cursor: pointer; font-weight: 600;" onclick="closeModal('loginModal'); openRegisterModal()">Create one</span>
                </p>
            </div>

            <div id="login-step-reset-1" style="display:none">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin:0; font-weight: 800;">Reset Password</h3>
                    <button onclick="switchLoginStep('main')" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#94a3b8;">&larr;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Registration Email</label>
                    <input type="email" id="reset-email" class="form-input" placeholder="you@example.com">
                </div>
                <button class="login-submit" onclick="handleResetSendOTP()">Send Reset Code</button>
            </div>

            <div id="login-step-reset-2" style="display:none">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin:0; font-weight: 800;">Set New Password</h3>
                    <button onclick="switchLoginStep('reset-1')" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#94a3b8;">&larr;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Verification Code</label>
                    <input type="text" id="reset-otp" class="form-input" placeholder="123456">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="reset-new-pass" class="form-input" placeholder="********">
                </div>
                <button class="login-submit" onclick="doResetPassword()">Update Password</button>
            </div>

            <div id="login-step-reset-success" style="display:none; text-align: center;">
                <div style="font-size: 3.5rem; margin-bottom: 1.5rem;">üë§</div>
                <h3 style="margin:0; font-weight: 800; color: var(--success);">Password Updated</h3>
                <p style="margin: 1.5rem 0; color: #64748b; font-size: 0.9rem; line-height: 1.5;">
                    Your password has been reset successfully. Please use the username below to sign in:
                </p>
                <div style="background: #f1f5f9; padding: 1.25rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                    <label class="form-label" style="margin-bottom: 4px; color: #94a3b8;">Registered Username</label>
                    <div id="recovered-username" style="font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.01em;">---</div>
                </div>
                <button class="login-submit" onclick="switchLoginStep('main')">Proceed to Login</button>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin:0; font-weight: 800;">Create Account</h3>
                <button onclick="resetRegisterModal(); closeModal('registerModal');" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#94a3b8;">&times;</button>
            </div>
            <div id="reg-step-1">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="reg-email" class="form-input" placeholder="you@example.com">
                </div>
                <button class="login-submit" onclick="handleRegSendOTP()">Send Verification Code</button>
            </div>
            <div id="reg-step-2" style="display: none;">
                <div class="form-group"><label class="form-label">Verification Code</label><input type="text" id="reg-otp" class="form-input"></div>
                <div class="form-group"><label class="form-label">Username</label><input type="text" id="reg-user" class="form-input"></div>
                <div class="form-group"><label class="form-label">Password</label><input type="password" id="reg-pass" class="form-input"></div>
                <button class="login-submit" onclick="doRegister()">Complete Registration</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="font-weight: 800; margin-bottom: 1.5rem;">Dictionary Editor</h3>
            <div class="form-group"><input type="text" id="dict-ben" class="form-input" placeholder="Bengali word"></div>
            <div class="form-group"><input type="text" id="dict-mee" class="form-input" placeholder="Meetei Mayek equivalent"></div>
            <div class="form-group"><input type="password" id="dict-pass" class="form-input" placeholder="Admin PIN"></div>
            <button class="login-submit" onclick="updateDict()">Update Entry</button>
            <button class="login-submit" style="background: #e2e8f0; color: #475569; margin-top:10px;" onclick="closeModal('settingsModal')">Cancel</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyO3XHVrfXZgwwML9QoDc1OhVkEoREGlvWfbf2JMgE6d7BrFA9fU5cwOF25xwYz7vCg5Q/exec";
        let dictionary = [];
        let keymap = {};
        let previewTimeLeft = 300;
        let previewInterval = null;
        let isUserAuthenticated = false;
        let currentFileName = "Untitled.txt";

        // Shortcut Handlers
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey)) {
                if (e.key.toLowerCase() === 'a') {
                    const activeEl = document.activeElement;
                    if (activeEl && activeEl.classList.contains('page-content-area')) {
                        e.preventDefault();
                        selectAllPages();
                    }
                } else if (e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    saveFile();
                } else if (e.key.toLowerCase() === 'o') {
                    e.preventDefault();
                    openFile();
                }
            }
        });

        function selectAllPages() {
            const pages = document.querySelectorAll('.page-content-area');
            if (pages.length === 0) return;
            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(pages[0], 0);
            range.setEnd(pages[pages.length - 1], pages[pages.length - 1].childNodes.length);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // File Operations
        function openFile() {
            const input = document.getElementById('file-open-input');
            input.value = ""; 
            input.click();
        }

        function handleFileOpen(event) {
            const file = event.target.files[0];
            if (!file) return;
            showToast("Reading file...");
            currentFileName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const container = document.getElementById('pages-container');
                container.innerHTML = '';
                const contentArea = addNewTypingPage();
                contentArea.innerText = content;
                if (contentArea.scrollHeight > contentArea.clientHeight) checkPagination(contentArea);
                showToast(`Loaded: ${file.name}`);
                updatePageStatusDisplay();
            };
            reader.readAsText(file, 'UTF-8');
        }

        function saveFile() {
            const pages = document.querySelectorAll('.page-content-area');
            let content = "";
            pages.forEach((p, idx) => {
                content += p.innerText;
                if (idx < pages.length - 1) content += "\n"; 
            });
            let fileName = currentFileName || "Untitled.txt";
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            showToast("File Saved");
        }

        // Typing Core
        function initTypingTool() {
            const container = document.getElementById('pages-container');
            if (container.children.length === 0) addNewTypingPage();
            updatePageStatusDisplay();
        }

        function checkPagination(activeArea) {
             if (activeArea.scrollHeight > activeArea.clientHeight + 20) addNewTypingPage();
        }

        function addNewTypingPage() {
            const container = document.getElementById('pages-container');
            const page = document.createElement('div');
            page.className = 'word-page';
            const contentArea = document.createElement('div');
            contentArea.className = 'page-content-area';
            contentArea.contentEditable = "true";
            contentArea.spellcheck = false;
            contentArea.style.fontSize = document.getElementById('f-size').value;
            contentArea.style.lineHeight = document.getElementById('l-spacing').value;
            const activeAlign = document.querySelector('.align-btn.active');
            contentArea.style.textAlign = activeAlign ? activeAlign.id.split('-')[1] : 'left';
            
            contentArea.onkeydown = (e) => {
                const currentLang = document.getElementById('type-lang').value;
                
                // 1. Allow functional/control keys always
                const controlKeys = ['Backspace', 'Enter', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Delete', 'Home', 'End', 'Escape', 'Control', 'Shift', 'Alt', 'Meta'];
                if (controlKeys.includes(e.key) || e.ctrlKey || e.metaKey) {
                    if (e.key === 'Backspace') handleBackspaceNavigation(e, page, contentArea);
                    return;
                }

                // 2. Space is always allowed
                if (e.key === ' ') return;

                // 3. For Transliteration Mode (Bengali/Meetei)
                if (currentLang !== 'english') {
                    e.preventDefault(); // Stop default typing
                    
                    // Check if the key exists in the keymap (Visual Keyboard check)
                    const mapping = keymap[e.key];
                    if (mapping !== undefined && mapping !== null && mapping !== "") {
                        document.execCommand('insertText', false, mapping);
                    } else {
                        // Character is NOT in the Sheet/Keyboard - Silently block it
                    }
                } 
                // 4. For English mode, allow standard typing (since it uses system keyboard)
            };

            contentArea.oninput = () => {
                if (contentArea.scrollHeight > contentArea.clientHeight + 20) addNewTypingPage();
                updatePageStatusDisplay();
            };
            contentArea.onfocus = () => updatePageStatusDisplay();
            page.appendChild(contentArea);
            container.appendChild(page);
            updatePageStatusDisplay();
            contentArea.focus();
            return contentArea;
        }

        function handleBackspaceNavigation(e, page, contentArea) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                if (range.startOffset === 0 && range.endOffset === 0) {
                    const prevPage = page.previousElementSibling;
                    if (prevPage) {
                        const prevArea = prevPage.querySelector('.page-content-area');
                        if (contentArea.innerText.trim() === "") {
                            e.preventDefault();
                            page.remove();
                            prevArea.focus();
                            const newRange = document.createRange();
                            newRange.selectNodeContents(prevArea);
                            newRange.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(newRange);
                        }
                        updatePageStatusDisplay();
                    }
                }
            }
        }

        function updatePageStatusDisplay() {
            const pages = Array.from(document.querySelectorAll('.word-page'));
            const total = pages.length;
            const activeEl = document.activeElement;
            let current = 1;
            if (activeEl && activeEl.classList.contains('page-content-area')) {
                const activePage = activeEl.parentElement;
                current = pages.indexOf(activePage) + 1;
            }
            const statusText = document.getElementById('pageProgressText');
            if (statusText) statusText.innerText = `Page ${current > 0 ? current : 1} of ${total}`;
        }

        function applyTypingStyle(prop, val) {
            document.querySelectorAll('.page-content-area').forEach(area => area.style[prop] = val);
        }

        function setTextAlignment(align) {
            applyTypingStyle('textAlign', align);
            document.querySelectorAll('.align-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`align-${align}`).classList.add('active');
        }

        function switchView(id) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'typingToolView') initTypingTool();
        }

        // API & Auth
        async function apiPost(action, payload) {
            showToast("Processing...");
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload })
                });
                const result = await response.json();
                if (result.success) { showToast(result.message || "Success!"); return result; }
                else { showToast(result.message || "Action failed"); return result; }
            } catch (e) { showToast("Error processing request"); return null; }
        }

        function startPreviewTimer() {
            if (isUserAuthenticated) return;
            previewInterval = setInterval(() => {
                previewTimeLeft--;
                if (previewTimeLeft <= 0) {
                    clearInterval(previewInterval);
                    showlockOverlay("preview");
                }
            }, 1000);
        }

        function showlockOverlay(type) {
            const overlay = document.getElementById('lockOverlay');
            if (type === "expired") {
                document.getElementById('lock-emoji').textContent = "‚åõ";
                document.getElementById('lock-title').textContent = "Plan Expired";
                document.getElementById('lock-message').textContent = "Your plan has ended. To upgrade your plan and get full access, please contact the support team.";
                document.getElementById('lock-actions').style.display = "none"; 
            }
            overlay.style.display = 'flex';
            switchView('conversionView');
            document.getElementById('tool-buttons').style.display = 'none';
        }

        async function fetchDictionary() {
            try {
                const r = await fetch(`${SCRIPT_URL}?action=getDictionary`);
                dictionary = await r.json();
                handleConversion();
            } catch (e) {}
        }

        async function fetchKeymap(name) {
            if (!name || name === 'english') { keymap = {}; return; }
            showToast("Loading keyboard...");
            try {
                const r = await fetch(`${SCRIPT_URL}?type=keymap&sheetName=${encodeURIComponent(name)}`);
                keymap = await r.json();
                if (document.getElementById('kb-map').style.display === 'block') renderKeys();
                showToast("Keyboard ready");
            } catch (e) {}
        }

        function handleConversion() {
            const txt = document.getElementById('input-text').value;
            const out = document.getElementById('output-text');
            const iL = document.getElementById('in-lang').value, oL = document.getElementById('out-lang').value;
            if (!txt || iL === oL) { out.value = txt; return; }
            const sorted = [...dictionary].sort((a, b) => (String(b[iL] || "").length) - (String(a[iL] || "").length));
            let res = txt;
            sorted.forEach(item => {
                const s = String(item[iL] || ""), t = String(item[oL] || "");
                if (s && t) res = res.replace(new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), t);
            });
            out.value = res;
        }

        function swapLangs() {
            const i = document.getElementById('in-lang'), o = document.getElementById('out-lang');
            [i.value, o.value] = [o.value, i.value];
            handleConversion();
        }

        async function doLogin() {
            const user = document.getElementById('user').value, pass = document.getElementById('pass').value;
            if (!user || !pass) return showToast("Enter credentials");
            const res = await apiPost('loginUser', { user, pass });
            if (res && res.success) {
                const exp = res.trial_end_date ? new Date(res.trial_end_date) : null;
                const diff = exp ? Math.ceil((exp - new Date()) / 86400000) : -1;
                if (exp && diff <= 0) { showlockOverlay("expired"); return; }
                isUserAuthenticated = true;
                clearInterval(previewInterval);
                document.getElementById('logged-out-auth').style.display = 'none';
                document.getElementById('logged-in-user-area').style.display = 'flex';
                document.getElementById('display-user-name').textContent = res.user || user;
                document.getElementById('display-user-days').textContent = exp ? `${diff} Days Left` : "Active Plan";
                document.getElementById('tool-buttons').style.display = 'flex';
                document.getElementById('lockOverlay').style.display = 'none';
                document.getElementById('header-reg-btn').style.display = 'none';
                closeModal('loginModal');
            }
        }

        function openRegisterModal() {
            if (isUserAuthenticated) return showToast("Already logged in");
            openModal('registerModal');
        }

        async function handleRegSendOTP() {
            const email = document.getElementById('reg-email').value;
            if (!email) return showToast("Enter email");
            const res = await apiPost('sendOTP', { email, mode: 'registration' });
            if (res && res.success) {
                document.getElementById('reg-step-1').style.display = 'none';
                document.getElementById('reg-step-2').style.display = 'block';
            }
        }

        async function doRegister() {
            const email = document.getElementById('reg-email').value, user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value, otp = document.getElementById('reg-otp').value;
            if (await apiPost('registerUser', { email, username: user, password: pass, otp })) {
                closeModal('registerModal'); openModal('loginModal');
            }
        }

        async function handleResetSendOTP() {
            const email = document.getElementById('reset-email').value;
            if (!email) return showToast("Enter email");
            if (await apiPost('sendResetOTP', { email })) switchLoginStep('reset-2');
        }

        async function doResetPassword() {
            const email = document.getElementById('reset-email').value, otp = document.getElementById('reset-otp').value, newPass = document.getElementById('reset-new-pass').value;
            const res = await apiPost('resetPassword', { email, otp, newPass });
            if (res && res.success) {
                document.getElementById('recovered-username').textContent = res.username || "Unknown";
                switchLoginStep('reset-success');
            }
        }

        async function updateDict() {
            const b = document.getElementById('dict-ben').value, m = document.getElementById('dict-mee').value, p = document.getElementById('dict-pass').value;
            if (p !== "2025") return showToast("Wrong PIN");
            if (await apiPost('updateDictionary', { bengali: b, meetei: m })) { fetchDictionary(); closeModal('settingsModal'); }
        }

        function updateKeyboardOptions() {
            const lang = document.getElementById('type-lang').value;
            const sel = document.getElementById('kb-layout');
            sel.style.display = lang === 'english' ? 'none' : 'inline-block';
            if (lang === 'english') { keymap = {}; if (document.getElementById('kb-map').style.display === 'block') renderKeys(); }
            else if (lang === 'bengali') { sel.innerHTML = '<option value="Smpl_Bengali">Smpl_Bengali</option><option value="Modular Bengali">Modular Bengali</option>'; fetchKeymap(sel.value); }
            else if (lang === 'meetei') { sel.innerHTML = '<option value="Smpl_Meetei Mayek">Smpl_Meetei Mayek</option><option value="Modular Meetei Mayek">Modular Meetei Mayek</option>'; fetchKeymap(sel.value); }
        }

        function toggleKeyboardMap() {
            const m = document.getElementById('kb-map');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
            if (m.style.display === 'block') renderKeys();
        }

        function renderKeys() {
            const grid = document.getElementById('kb-grid');
            grid.innerHTML = "";
            const rows = ["~@$%", "QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM","qwertyuiop", "asdfghjkl", "zxcvbnm"];
            rows.forEach(r => {
                const div = document.createElement('div'); div.className = 'kb-row';
                let valid = false;
                r.split('').forEach(k => { 
                    if (keymap && keymap[k]) {
                        div.innerHTML += `<div class="kb-key"><span>${k}</span><span class="char">${keymap[k]}</span></div>`;
                        valid = true;
                    }
                });
                if (valid) grid.appendChild(div);
            });
            if (grid.innerHTML === "") grid.innerHTML = "<div style='text-align:center; padding: 20px; color: #94a3b8;'>No mapped characters.</div>";
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function resetRegisterModal() { document.getElementById('reg-step-1').style.display = 'block'; document.getElementById('reg-step-2').style.display = 'none'; }
        function switchLoginStep(step) {
            ['main', 'reset-1', 'reset-2', 'reset-success'].forEach(s => {
                const el = document.getElementById(`login-step-${s}`);
                if (el) el.style.display = (step === s) ? 'block' : 'none';
            });
        }

        function exportToDoc() {
            let html = "";
            document.querySelectorAll('.page-content-area').forEach(a => html += `<div>${a.innerHTML}</div><br style="page-break-before:always">`);
            const blob = new Blob(['\ufeff', `<html><head><meta charset='utf-8'></head><body>${html}</body></html>`], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Manipuri_Doc.doc';
            link.click();
        }

        function showToast(m) { 
            const t = document.getElementById('toast'); 
            t.textContent = m; t.style.display = 'block'; 
            if (m !== "Processing...") setTimeout(() => t.style.display = 'none', 3000); 
        }

        window.onload = () => { fetchDictionary(); startPreviewTimer(); initTypingTool(); };
    </script>
</body>
</html>
